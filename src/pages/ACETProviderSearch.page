<apex:page controller="ACETProviderSearchController" sidebar="false"
    tabStyle="Provider_Search__tab">
    <apex:includeScript value="{!$Resource.JQuery}"></apex:includeScript>
    <apex:includeScript value="/support/console/37.0/integration.js" />
    <script type="text/javascript" src="https://js-cdn.dynatrace.com/jstag/145e12d594f/xob29014/1077eb28288ea333_bs.js" crossorigin="anonymous"></script> 
    <apex:form id="theFormId">     
        <apex:actionfunction name="afSearch" action="{!Search}" status="refreshMemberStatus" reRender="opSearchResult,pmMessages" oncomplete="initDatatable();"/>
        <apex:actionFunction name="afClear" action="{!clearResults}" status="refreshMemberStatus" reRender="opSearchResult"/>
        <apex:sectionHeader title="" subtitle="{!$Label.ACETProviderSearchHeaderSubTitle}" />
        <apex:pageMessages id="pmMessages" />
        <apex:pageBlock mode="maindetail">
            <apex:pageBlockSection id="pbsMainDetail">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchInteractionTypeLabel}" />
                    <apex:selectList id="InteractionType" value="{!InteractionType}"
                        size="1">
                        <apex:selectOptions value="{!InteractionTypes}" />
                    </apex:selectList>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
        </apex:pageBlock>
        <apex:pageBlock Id="pbSearchCriteria">
            <apex:pageblockSection columns="2" id="pbsSearchCriteria">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchContactNameLabel}"></apex:outputLabel>
                    <apex:inputText value="{!CallerName}" id="CallerName" maxlength="100" />
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchTaxIdLabel}"></apex:outputLabel>
                    <apex:inputText value="{!TaxID}" id="TaxID" maxlength="9" />
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchNPILabel}"></apex:outputLabel>
                    <apex:inputText value="{!NPI}" id="NPI" maxlength="10" />
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchLastNameLabel}"></apex:outputLabel>
                    <apex:inputText value="{!LastName}" id="LastName" maxlength="80" />
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchFirstNameLabel}"></apex:outputLabel>
                    <apex:inputText value="{!FirstName}" id="FirstName" maxlength="40" />
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchStateLabel}"></apex:outputLabel>
                    <c:ACETStateCode StateCodeContainerAtt="{!StateCode}"></c:ACETStateCode>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchZipCodeLabel}"></apex:outputLabel>
                    <apex:inputText value="{!ZipCode}" id="ZipCode" maxlength="5" />
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchPhoneNumberLabel}"></apex:outputLabel>
                    <apex:inputText value="{!PhoneNumber}" id="PhoneNumber" maxlength="10" />
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.ACETProviderSearchFilterTypeLabel}"></apex:outputLabel>
                    <apex:selectList id="FilterBy" label="Provider Type"
                        value="{!FilterBy}" size="1">
                        <apex:selectOption itemValue="Both" itemLabel="--None--" />
                        <apex:selectOption itemValue="FACL" itemLabel="Facility/Group" />
                        <apex:selectOption itemValue="PROF" itemLabel="Physician" />
                    </apex:selectList>
                </apex:pageBlockSectionItem>
            </apex:pageblockSection>
            <apex:pageBlockButtons location="bottom">
                <input id="btnSearch" type="button" class="btn" value="{!$Label.ACETProviderSearchSearchButtonLabel}" onClick="return validate();" />
                <input id="btnClear" type="button" class="btn" value="{!$Label.ACETProviderSearchClearButtonLabel}" onclick="ClearSearchCriteria();" />   
            </apex:pageBlockButtons>
        </apex:pageBlock>
        <apex:actionStatus id="refreshMemberStatus">
            <apex:facet name="start">
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.25; z-index: 1000; background-color: black;">
                    &nbsp;
                </div>
                <div style="position: fixed; left: 0; top: 0; bottom: 0; right: 0; z-index: 1001; margin: 15% 50%">
                    <div style="display: inline-block; padding: 2px; background-color: #fff; width: 125px;">
                        <img src="/img/loading.gif" style="float: left; margin: 8px;" />
                        <span style="display: inline-block; padding: 10px 0px;">Loading...</span>
                    </div>
                </div>
            </apex:facet>
        </apex:actionStatus>
        <apex:outputPanel id="opSearchResult">
        	<apex:pageBlock Id="pbSearchResult" title="{!$Label.ACETProviderSearchResultsHeaderTitle}" rendered="{!NOT(ISNULL(DTWrapper))}">
	            <apex:pageBlockButtons location="Top">
	                <apex:commandButton value="{!$Label.ACETProviderSearchProviderNotFoundButtonLabel}" rendered="{!NOT(ISNULL(DTWrapper))}" onclick="return ProviderNotFound();" />
	            </apex:pageBlockButtons>
	           	<apex:pageBlockSection columns="1" html-auto-doc="true" html-auto-doc-case-items="true" collapsible="false" rendered="{!NOT(ISNULL(DTWrapper))}">
	              		<c:ACETDataTable attrDatatableWrapper="{!DTWrapper}" rendered="{!NOT(ISNULL(DTWrapper))}"/>
	              	</apex:pageBlockSection>
	           	<c:ACETCaseActions Save="{!Save}" attrRefreshNavigationTab="true"
	                SaveAndClose="{!SaveAndClose}" attrShowSaveAndCloseButton="false"
	                attrShowSaveButton="false" attrShowMisdirectButton="true"
	                attrShowCancelButton="false"
	                attrSourceOriginator="{!InteractionType}"
	                attrInteractionId="{!wrapper.Interaction.Id}"
	                attrSubjectId="{!wrapper.Subject.Id}"
	                rendered="{!NOT(ISNULL(DTWrapper))}" />
        	</apex:pageBlock>
        </apex:outputPanel>     
    </apex:form>
    <script type="text/javascript">
        var $SearchCriteria = $("[id$='pbSearchCriteria']");
        var $InteractionType = $("[id$='InteractionType']");
        var $CallerName  = $("[id$='CallerName']");
        var $TaxId       = $("[id$='TaxID']");
        var $NPI         = $("[id$='NPI']");
        var $LastName    = $("[id$='LastName']");
        var $FirstName   = $("[id$='FirstName']");
        var $State       = $("[id$='ddlStateCode']");
        var $ZipCode     = $("[id$='ZipCode']");
        var $PhoneNumber = $("[id$='PhoneNumber']");
        var $FilterBy = $("[id$='FilterBy']");
        function validate()
        {
            $SearchCriteria.find(".pbError").remove();
            $TaxId.removeClass("error").parent().find(".errorMsg").remove();
            $NPI.removeClass("error").parent().find(".errorMsg").remove();
            $LastName.removeClass("error").parent().find(".errorMsg").remove();
            $FirstName.removeClass("error").parent().find(".errorMsg").remove();
            $State.removeClass("error").parent().find(".errorMsg").remove();
            $PhoneNumber.removeClass("error").parent().find(".errorMsg").remove();
            $ZipCode.removeClass("error").parent().find(".errorMsg").remove();
    
            var ValidationResult = true;
            if($TaxId.val()) {
                if($TaxId.val().length < 9) {
                    $TaxId.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETProviderSearchTaxIdMinCharErrorMessage}</div>');
                    ValidationResult = false;
                }
            }
    
            if($NPI.val()) {
                if($NPI.val().length < 10) {
                    $NPI.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETProviderSearchNPIMinCharErrorMessage}</div>');
                    ValidationResult = false;
                }
            }
    
            if($LastName.val()) {
                if($LastName.val().indexOf('*') >= 0) {
                    if ($LastName.val().length < 4) {
                        $LastName.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETProviderSearchLastNameMinCharErrorMessage}</div>');
                        ValidationResult = false;
                    }
                    else if($LastName.val().substring($LastName.val().indexOf('*')).length > 1) {
                        $LastName.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETProviderSearchLastNameMinCharErrorMessage}</div>');
                        ValidationResult = false;
                    }
                }
            }
    
            if($FirstName.val()) {
                if($FirstName.val().indexOf('*') >= 0) {
                    if($FirstName.val().length < 2) {
                        $FirstName.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETProviderSearchFirstNameMinCharErrorMessage}</div>');
                        ValidationResult = false;
                    }
                    else if($FirstName.val().substring($FirstName.val().indexOf('*')).length > 1) {
                        $FirstName.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETProviderSearchFirstNameMinCharErrorMessage}</div>');
                        ValidationResult = false;
                    }
                }
            }
    
            if($ZipCode.val()) {
                if($ZipCode.val().length < 5) {
                    $ZipCode.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETProviderSearchZipCodeMinCharErrorMessage}</div>');
                    ValidationResult = false;
                }
            }
    
            if($PhoneNumber.val()) {
                if($PhoneNumber.val().length < 10) {
                    $PhoneNumber.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETProviderSearchPhoneNumberMinCharErrorMessage}</div>');
                    ValidationResult = false;
                }
            }
    
            if (!ValidationResult)
            {
                $SearchCriteria.prepend('<div class="pbError">{!$Label.ACETProviderSearchInvalidDataErrorMessage}<br/>{!$Label.ACETProviderSearchReviewErrorMessage}</div>');
            }
            else
            {
                if ($TaxId.val() || $NPI.val() || $PhoneNumber.val()) {
                    ValidationResult = true;        //Allow search on Tax ID or NPI or Phone Number alone
                }
                else if ($LastName.val()) {    //Tax ID, NPI and Phone Number are blank and Last Name or Facility/Group Name is not blank, check if State or Zip Code is entered
                    var errorMsg;
                    if ($FirstName.val()) {
                        if ($State.val() || $ZipCode.val()) {
                            ValidationResult = true;
                        }
                        else {
                            errorMsg = '{!$Label.ACETProviderSearchLNameNFNameAloneErrorMessage}';
                            ValidationResult = false;
                        }
                    }
                    else {
                        if ($State.val() || $ZipCode.val()) {
                            ValidationResult = true;
                        }
                        else {
                            errorMsg = '{!$Label.ACETProviderSearchLNameAloneErrorMessage}';
                            ValidationResult = false;
                        }
                    }
                    if (!ValidationResult)
                    {
                        $SearchCriteria.prepend('<div class="pbError">{!$Label.ACETProviderSearchInvalidDataErrorMessage}<br/>' + errorMsg + '</div>');
                        $State.addClass("error");
                        $ZipCode.addClass("error");
                    }
                } //end of if ($LastName.val())
                else if ($FirstName.val()) {    //Tax ID, NPI and Phone Number and Last Name or Facility/Group Name are blank and First Name is not blank, check if State or Zip Code is entered
                    ValidationResult = false;
                    $LastName.addClass("error");
                    var errorMsg;
                    if (!$State.val() && !$ZipCode.val()) {
                        errorMsg = '{!$Label.ACETProviderSearchFNameAloneErrorMessage}';
                        $State.addClass("error");
                        $ZipCode.addClass("error");
                    }
                    else if ($State.val() && !$ZipCode.val()) {
                        errorMsg = '{!$Label.ACETProviderSearchFNameNStateAloneErrorMessage}';
                    }
                    else if (!$State.val() && $ZipCode.val()) {
                        errorMsg = '{!$Label.ACETProviderSearchFNameNZipAloneErrorMessage}';
                    }
                    else {
                        errorMsg = '{!$Label.ACETProviderSearchFNameNStateNZipAloneErrorMessage}';
                    }
                    $SearchCriteria.prepend('<div class="pbError">{!$Label.ACETProviderSearchInvalidDataErrorMessage}<br/>' + errorMsg + '</div>');
                } //end of if ($FirstName.val())
                else if ($State.val()) {
                    ValidationResult = false;
                    $TaxId.addClass("error");
                    $NPI.addClass("error");
                    $PhoneNumber.addClass("error");
                    $LastName.addClass("error");
                    var errorMsg;
                    if ($ZipCode.val()) {
                        errorMsg = '{!$Label.ACETProviderSearchStateNZipCodeAloneErrorMessage}';
                    }
                    else {
                        errorMsg = '{!$Label.ACETProviderSearchStateAloneErrorMessage}';
                    }
                    $SearchCriteria.prepend('<div class="pbError">{!$Label.ACETProviderSearchInvalidDataErrorMessage}<br/>' + errorMsg + '</div>');
                } //end of if ($State.val())
                else if ($ZipCode.val()) {
                    ValidationResult = false;
                    $TaxId.addClass("error");
                    $NPI.addClass("error");
                    $PhoneNumber.addClass("error");
                    $LastName.addClass("error");
                    $SearchCriteria.prepend('<div class="pbError">{!$Label.ACETProviderSearchInvalidDataErrorMessage}<br/>{!$Label.ACETProviderSearchZipCodeAloneErrorMessage}</div>');
                }
                else {
                    ValidationResult = false;
                    $SearchCriteria.prepend('<div class="pbError">{!$Label.ACETProviderSearchInvalidDataErrorMessage}<br/>{!$Label.ACETProviderSearchValidCriteriaErrorMessage}</div>');
                }
            }
            
            if (ValidationResult == true){
                afSearch();
            	return false;
            }        
    
            return ValidationResult;
    
        }
    
        function ClearSearchCriteria()
        {
            $SearchCriteria.find(".pbError").remove();
            $TaxId.removeClass("error").parent().find(".errorMsg").remove();
            $NPI.removeClass("error").parent().find(".errorMsg").remove();
            $LastName.removeClass("error").parent().find(".errorMsg").remove();
            $FirstName.removeClass("error").parent().find(".errorMsg").remove();
            $State.removeClass("error").parent().find(".errorMsg").remove();
            $PhoneNumber.removeClass("error").parent().find(".errorMsg").remove();
            $ZipCode.removeClass("error").parent().find(".errorMsg").remove();
    
            $TaxId.val("");
            $NPI.val("");
            $LastName.val("");
            $FirstName.val("");
            $State.val("");
            $ZipCode.val("");
            $PhoneNumber.val("");
            $FilterBy.val("");
    
            afClear();
        }
    
        function ProviderNotFound()
        {
            var InteractionType = $InteractionType.val();
            var ContactName = $CallerName.val();
            var TaxID = $TaxId.val();
            var NPI = $NPI.val();
            var LastName = $LastName.val();
            var FirstName = $FirstName.val();
            var PhoneNumber = $PhoneNumber.val();
    
            var dtNow = new Date();
            var dtTime = dtNow.getTime();
            var RedirectURL = '/apex/ACETProviderNotFoundForm?IT=' + InteractionType + '&CN=' + ContactName + '&TID=' + TaxID + '&NPI=' + NPI + '&LN=' + LastName + '&FN=' + FirstName + '&Phone=' + PhoneNumber + '&TS=' + dtTime;
    
            sforce.console.openPrimaryTab(null, RedirectURL, true, 'Provider Not Found', null, 'PNF' + dtTime);
    
            return false;
        }

        function init()
        {
            $TaxId.keypress(AllowDigitsOnly);
            $NPI.keypress(AllowDigitsOnly);
            $ZipCode.keypress(AllowDigitsOnly);
            $PhoneNumber.keypress(AllowDigitsOnly);
        }
    
        function AllowDigitsOnly(InputElement)
        {
            //Allow delete, tab, enter and escape keys through
            if (/^(8|9|13|27)$/.test("" + InputElement.keyCode))
            {
                return true;
            }
    
            var regex = new RegExp("^[0-9]+$");
            var str = String.fromCharCode(!InputElement.charCode ? InputElement.which : InputElement.charCode);
            if (regex.test(str))
            {
                return true;
            }
    
            InputElement.preventDefault();
            return false;
        }
        
        function setPriTabStyle(result) { 
            if (result.success) {
                sforce.console.setTabStyle('background: ;', result.id);
            } 
        }
        
        function onloadSetTabTitle() {
            //Set the current tabs title
            sforce.console.getEnclosingPrimaryTabId(setPriTabStyle);
            sforce.console.setTabTitle('Provider Search');            
        }
        
         $(document).ready(function() {
             onloadSetTabTitle();
             init();
         });
         
         $(document).ready(function() {
             var noAutoSearch = '{!JSENCODE($CurrentPage.parameters.noAutoSearch)}'; 
             if(noAutoSearch != 'true'){
                 var vccdParams;
                 vccdParams =  JSON.parse('{!JSENCODE($CurrentPage.parameters.vccdParams)}');
                 if(vccdParams.TaxID != '' && vccdParams.TaxID != undefined && vccdParams.TaxID != null){
                     $("[id$='TaxID']").val(vccdParams.TaxID); 
                     $("[id$='NPI']").val(vccdParams.npi);               
                     $("[id$='btnSearch']").click();
                 }
    
             }
         });         
    	
		function processDatatable(row, data, dataIndex) {
        	$(row).children().first().html("<a id='lnkTaxId' href='#'>" + data.taxId + "</a>");                     
            $(row).children().first().on('click', function(e) {
            	console.log('$InteractionType.val(): ' + $InteractionType.val() + ', $CallerName.val(): ' + $CallerName.val());
            	console.log('data.providerId: ' + data.providerId + ', data.taxId: ' + data.taxId + ', data.NPI: ' + data.NPI);
            	console.log('data.fullName: ' + data.fullName + ', data.providerType: ' + data.providerType);
            	Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.ACETProviderSearchController.RedirectToProviderDetail}',
                	$InteractionType.val(), $CallerName.val(), data.providerId, data.taxId, data.NPI, data.fullName, data.providerType,
	                function(result, event) {
	                    if (event.status) {
	                        var vccdParams = '{!JSENCODE($CurrentPage.parameters.vccdParams)}';
	                        var url = '/apex/ACETProviderDetail?Id=' + result.Id + '&Type=ProviderNotFound&vccdParams=' + vccdParams + '&ProviderTypeCode=' + data.providerTypeCode;
	                        url += '&providerTINStatusCode=' + data.providerTINStatusCode + '&ProvideraddressTypeCode=' + data.addressTypeCode;
	                        url += '&providerTINOwner=' + data.owner + '&addressId=' + data.addressId + '&providerTINTypeCode=' + data.providerTINTypeCode;
	                        sforce.console.openPrimaryTab(null, url, true, 'Detail - ' + result.Originator__r.LastName);
	                    }
	                    else if (event.type === 'exception') {
	                    }
	                    else {
	                    }
	                },
	                {escape: true}
            	);
				return false;
            });
        }    	
    </script>
    <style>
        .headerResultStyle {
        font-size: 12px;
        font-weight: Bold;
        }
    </style>
    <apex:includeScript value="{!URLFOR($Resource.ACETResources, '/js/main.js')}" />
</apex:page>