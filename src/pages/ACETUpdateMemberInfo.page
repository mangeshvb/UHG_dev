<apex:page controller="ACETUpdateMemberInfoController" sidebar="false"  applyHtmlTag="true" action="{!memberData}" docType="html-5.0">
    <apex:includeScript value="{!$Resource.JQuery}"></apex:includeScript>
    <apex:stylesheet value="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <apex:includeScript value="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></apex:includeScript>
    <apex:includeScript value="/soap/ajax/38.0/connection.js" />
    <apex:includeScript value="/support/console/30.0/integration.js" />
    
    <apex:includeScript value="{!URLFOR($Resource.ACETResources, '/js/main.js')}" />
    <script type="text/javascript" src="https://js-cdn.dynatrace.com/jstag/145e12d594f/xob29014/1077eb28288ea333_bs.js" crossorigin="anonymous"></script>
    <style>
    .pbSubheader{
        background-color: transparent;
    }
    </style>

    <script>
        $(document).ready(function() {
            acet.autodoc.startAutodoc();
            acet.autodoc.createCommentsbox();
        });        
        
    </script>       
    <apex:form id="updatefrm" >
        <apex:outputPanel >
        <c:ACETInteractionHighlightsPanel InteractionAtt="{!wrapper.interaction}" SubjectAtt="{!wrapper.Subject}" AdditionalInfoAtt="{!wrapper.AdditionalInfo}" html-auto-doc="auto"/>       
        </apex:outputPanel>

        <apex:sectionHeader Title="Update Member Detail" />
        <apex:actionFunction action="{!updateMember}" name="updateMemberdata" status="refreshMemberStatus" rerender="opid" / >
        <apex:actionFunction action="{!memberData}" name="refreshMemberdata" />
        
        <apex:actionStatus id="refreshMemberStatus"  >
            <apex:facet name="start">
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.25; z-index: 1000; background-color: black;">
                &nbsp;
            </div>
            <div style="position: fixed; left: 0; top: 0; bottom: 0; right: 0; z-index: 1001; margin: 15% 50%">
                <div style="display: inline-block; padding: 2px; background-color: #fff; width: 125px;">
                    <img src="/img/loading.gif" style="float: left; margin: 8px;" />
                    <span style="display: inline-block; padding: 10px 0px;">Loading...</span>
                </div>
            </div>
        </apex:facet>
        </apex:actionStatus>
        <apex:outputPanel id="panelId">
        <apex:outputPanel id="opid">
            <apex:pageMessages />                      
            <div style="margin-left: 10%;">
                <c:ACETCaseActions attrCaseDataWrapper="{!wrapper}" attrShowSaveAndCloseButton="false"
                    attrShowSaveButton="true" 
                    attrSourceOriginator="{!wrapper.SourceOriginator}"
                    attrInteractionId="{!wrapper.Interaction.Id}"
                    attrSubjectId="{!wrapper.Subject.Id}"
                    attrCallTopic="{!wrapper.CaseObj.Topic__c}" rendered="{!isClickedUpdate}"
                    attrShowMisdirectButton="true" attrRefreshNavigationTab="false" id="cmpntId"/>
            </div>
        </apex:outputPanel>
            <apex:pageBlock id="pbid"  mode="mainDetail">
               <apex:pageBlockButtons location="top">
                       <apex:commandButton id="btnUpdate" style="margin-left:14%;" value="Update" onclick="return check('{!phoneWrprList.size}');" action="{!updateMember}" />
                       <apex:commandButton id="btnReset" value="Reset" onclick="refreshMemberdata();" rendered="{!!isClickedUpdate}" status="refreshMemberStatus" reRender="panelId"/>
               </apex:pageBlockButtons> 
                        
               <apex:pageBlockSection id="pbsPhone" title="Phone" columns="1" html-auto-doc="true" html-auto-doc-case-items="true">
                    <script>
                        acet.autodoc.startAutodoc(); 
                        $ = jQuery.noConflict();
                        var $phoneNumber = $("[id$='phoneNumber']");                        
                        function init()
                        {
                            $phoneNumber.keypress(AllowDigitsOnly);
                            $phoneNumber.keyup(formatphone);                            
                        }
                        function formatphone(InputElement){
                            var val = this.value.replace(/\D/g, '');
                            var newVal = '';
                            var count = 0;
                            while (val.length > 3) {
                              if(count < 2){
                                  newVal += val.substr(0, 3) + '-';
                                  val = val.substr(3);
                                  count++ ;
                              }
                              if(count == 2)
                                  break;
                            }
                            newVal += val;
                            this.value = newVal;
                            
                        }                        
                        function AllowDigitsOnly(InputElement)
                        {                                                       
                            //Allow delete, tab, enter and escape keys through
                            if (/^(8|9|13|27|45)$/.test("" + InputElement.keyCode))
                            {
                                return true;
                            }
                    
                            var regex = new RegExp("^[0-9 -]+$");
                            var str = String.fromCharCode(!InputElement.charCode ? InputElement.which : InputElement.charCode);
                             
                            if (regex.test(str))
                            {                                
                                return true;
                            }
                    
                            InputElement.preventDefault();
                            return false;
                        }
                        $(document).ready(function() {
                             init();
                             
                        });                       
                                              
                    </script>
                    <apex:pageBlockTable value="{!phoneWrprList}" var="pw" id="theRepeatPhone" columnsWidth="5%,15%,30%,30%,20%" >

                        <apex:column headerValue="Phone Number Type" >
                                <apex:selectList id="phoneNumberType" size="1" value="{!pw.phone.PhoneNumberType}" disabled="{!pw.makeReadOnly}">
                                    <apex:selectOptions value="{!PhoneNumberType}"></apex:selectOptions>
                                </apex:selectList>
                        </apex:column>                        
                        <apex:column headerValue="Phone Number">         
                            <apex:inputText value="{!pw.phone.PhoneNumber}" id="phoneNumber"  maxlength="12"/>
                        </apex:column>
                        <apex:column headerValue="Primary ?">
                                <apex:selectList id="Indicator" size="1" value="{!pw.phone.PrimaryIndicator}" disabled="{!pw.makePrimaryIndiReadOnly}">                                    
                                    <apex:selectOptions value="{!pw.PrimaryIndicator}" ></apex:selectOptions>
                                </apex:selectList>         
                        </apex:column>
                    </apex:pageBlockTable>   
                       
                                     
                </apex:pageBlockSection>
                <apex:commandlink id="addPhoneBtn" action="{!addPhRow}" style="cursor:pointer;" rerender="pbsPhone,pbid" status="refreshMemberStatus1"><apex:image id="plusIcon" value="{!$Resource.UpdateMemberPlusIcon}"/></apex:commandlink>
                <apex:pageBlockSection id="pbsEmail" title="Email" columns="1" html-auto-doc="true" html-auto-doc-case-items="true">
                    <script>                                                
                        acet.autodoc.startAutodoc();
                        
                    </script>
                    <apex:pageBlockTable value="{!emailWrpr}" var="eml" id="theRepeatEmail" columnsWidth="5%,15%,60%,20%">                        
                        <apex:column headerValue="Email Type" >
                            <apex:selectList id="emailType" size="1" value="{!eml.emailTypeStr}" disabled="true" >
                                <apex:selectOptions value="{!emailType}"></apex:selectOptions>
                            </apex:selectList>
                        </apex:column>
                        
                        <apex:column headerValue="Email">
                            <apex:input type="email" value="{!eml.Email}" id="email" />
                        </apex:column>    
                    </apex:pageBlockTable> 
                                  
                </apex:pageBlockSection>
                <apex:actionStatus id="refreshMemberStatus1">
                <apex:facet name="start">
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.25; z-index: 1000; background-color: black;">
                        &nbsp;
                    </div>
                    <div style="position: fixed; left: 0; top: 0; bottom: 0; right: 0; z-index: 1001; margin: 15% 50%">
                        <div style="display: inline-block; padding: 2px; background-color: #fff; width: 125px;">
                            <img src="/img/loading.gif" style="float: left; margin: 8px;" />
                            <span style="display: inline-block; padding: 10px 0px;">Loading...</span>
                        </div>
                    </div>
                </apex:facet>
                </apex:actionStatus>
                <apex:commandlink id="addEmailBtn" rerender="pbsEmail" action="{!addEmailRow}" rendered="{!emailWrpr == null}" status="refreshMemberStatus1" ><apex:image id="plusIcon2" value="{!$Resource.UpdateMemberPlusIcon}"/></apex:commandlink>                 
                <apex:outputPanel rendered="{!isClickedUpdate}">
                <apex:pageBlockSection Title="Documentation" columns="1" html-auto-doc="{!IF(wrapper.isSystemUnavailable, 'auto', 'false')}" >
                    <apex:pageBlockSectionItem html-auto-doc-item="false" >    
                       <apex:outputLabel value="Comments"></apex:outputLabel>
                       <apex:inputTextArea id="comments" cols="100" rows="5" value="{!wrapper.Comments}"  html-maxlength="3999" style="margin-left: 10px;"/>
                    </apex:pageBlockSectionItem>
                    
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="System Unavailable"></apex:outputLabel>
                        <apex:inputCheckbox id="sysUnavailableChkb"
                            style="margin-left:10px;" value="{!wrapper.isSystemUnavailable }" />
                    </apex:pageBlockSectionItem>
                
                </apex:pageBlockSection>
                </apex:outputPanel>
                
            </apex:pageBlock>
            <br />
            <div style="margin-left: 10%;">
                <c:ACETCaseActions attrCaseDataWrapper="{!wrapper}" attrShowSaveAndCloseButton="false"
                    attrShowSaveButton="true" 
                    attrSourceOriginator="{!wrapper.SourceOriginator}"
                    attrInteractionId="{!wrapper.Interaction.Id}"
                    attrSubjectId="{!wrapper.Subject.Id}"
                    attrCallTopic="{!wrapper.CaseObj.Topic__c}"  rendered="{!isClickedUpdate}"
                    attrShowMisdirectButton="true" attrRefreshNavigationTab="false" 
                    attrLocation="bottom"/>
            </div>
            <br />
        </apex:outputPanel>
    </apex:form>
    <apex:outputpanel rendered="{!updated}">
        <script>
            testGetFocusedPrimaryTabId();
            function testGetFocusedPrimaryTabId() {
                sforce.console.getEnclosingPrimaryTabId(function(result){
                    sforce.console.getSubtabIds(result.id , refreshSuccess);
                });
            }
            var refreshSuccess = function refreshSuccess(result) {
            //Report whether refreshing the subtab was successful
            if (result.success == true) {
                var tabid = result.ids[0] ;
                sforce.console.refreshSubtabById( tabid, true);
            }
            
        };
        </script>
    </apex:outputpanel>
    <script> 
        $ = jQuery.noConflict();
        var $phoneNumber = $("[id$='phoneNumber']");        
        var phonenum = $phoneNumber.val();
        function init()
        {
            $phoneNumber.keyup(formatphone);                            
        }
        function formatphone(InputElement){
            var val = this.value.replace(/\D/g, '');
            var newVal = '';
            var count = 0;
            while (val.length > 3) {
              if(count < 2){
                  newVal += val.substr(0, 3) + '-';
                  val = val.substr(3);
                  count++ ;
              }
              if(count == 2)
                  break;
            }
            newVal += val;
            this.value = newVal;            
        }
        function check(size){
            var rowSize = size;
            var ValidationResult = true;
            for(var i = 0 ; i < rowSize ; i++ ){
                var rowNum = i;
                var phonStr = "[id$='"+rowNum+":phoneNumber']" ;
                var $phoneNumber = $(phonStr);
                $phoneNumber.find(".pbError").remove();
                ValidationResult = true;
                
                var phone = $phoneNumber.val();
                if($phoneNumber.val()) {
                    var regex = new RegExp("^[2-9]{1}[0-9]{2}-[2-9]{1}[0-9]{2}-[0-9]{4}$");
                    $phoneNumber.removeClass("error").parent().find(".errorMsg").remove();
                    if($phoneNumber.val().length < 12) {
                        $phoneNumber.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETPhoneNumValidationError}</div>');
                        ValidationResult = false;
                        break;
                    }else if(!regex.test(phone)){
                        
                        $phoneNumber.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETPhoneNumValidationError}</div>');
                        ValidationResult = false;
                        break;
                    }
                }else
                {
                    $phoneNumber.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong>&nbsp;{!$Label.ACETPhoneNumValidationError}</div>');
                    ValidationResult = false;
                    break;    
                } 
                
                
            }
            return ValidationResult;
        }                                      
    </script>         
    <apex:includeScript value="{!URLFOR($Resource.ACETResources, '/js/main.js')}" />
</apex:page>