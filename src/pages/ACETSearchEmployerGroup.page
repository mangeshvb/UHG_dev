<apex:page controller="ACETSearchEmployerGroupController" sidebar="false" title="Group Search" >  
    <apex:includeScript value="{!$Resource.JQuery}"></apex:includeScript>     
    <apex:includeScript value="/support/console/38.0/integration.js"/>
    <apex:includeScript value="{!URLFOR($Resource.ACETResources, '/js/main.js')}"/> 
    <apex:form id="myform"> 
        <apex:inputHidden id="highlightPanelInfo" value="{!hpAdditionInfoStr}" />   
        <c:ACETInteractionHighlightsPanel InteractionAtt="{!Interaction}" AdditionalInfoAtt="{!AdditionalInfo}" rendered="{!NOT(IsGroup)}"></c:ACETInteractionHighlightsPanel>
        <apex:sectionHeader title="Group Search"/> 
        <apex:pageMessages />   
        <apex:pageBlock mode="maindetail">
            <apex:pageBlockSection >               
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Interaction Type" />
                    <apex:selectList id="sourceOriginator" value="{!SourceOriginator}" size="1" >
                        <apex:selectOptions value="{!SourceOriginators}" />
                    </apex:selectList>
                </apex:pageBlockSectionItem> 
            </apex:pageBlockSection>
        </apex:pageBlock>      
        <apex:pageBlock id="pbSearch">                           
            <apex:pageblockSection id="pbsSearch" columns="2">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Group ID"></apex:outputLabel>
                    <apex:inputText id="groupId"  html-autocomplete="off" value="{!groupId}"/>
                </apex:pageBlockSectionItem> 
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value=" Group Name"></apex:outputLabel>
                    <apex:inputText id="groupName" value="{!GName}"/>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >                    
                    <apex:outputLabel value="Group Tax ID"></apex:outputLabel>
                    <apex:inputText id="groupTaxId"  html-autocomplete="off" value="{!groupTaxId}"/>                   
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                        <apex:outputLabel value="State"></apex:outputLabel>
                        <apex:outputPanel layout="none">
                            <apex:selectList id="searchstate" size="1" value="{!State}">
                                <apex:selectOptions value="{!StateOptions}"></apex:selectOptions>
                            </apex:selectList>
                        </apex:outputPanel>
                    </apex:pageBlockSectionItem>
               </apex:pageBlockSection>
                <apex:pageBlockButtons location="bottom">   
                    <apex:commandButton id="btnSearch" value="Search" action="{!search}" onclick="return validate();"/>     
                    <apex:commandButton id="btnClear" value="Clear" action="{!clear}" onclick="return clearForm(); return false;"/>
                </apex:pageBlockButtons>
        </apex:pageBlock>
         <br></br>           
         <apex:outputPanel id="opSearchResult">     
         <apex:pageBlock id="pbSearchResult" title="Group Search Results" rendered="{!NOT(ISNULL(DTWrapper))}" >                   
            <c:ACETDataTable attrDatatableWrapper="{!DTWrapper}"/>
            <apex:pageBlockTable value="{!Results}" var="r" rendered="{!NOT(ISNULL(Results)) && Results.size == 0}">
                <apex:column headerValue="Search criteria returned no matches." width="100%"/>     
            </apex:pageBlockTable>
            <apex:actionFunction action="{!updateCache}" name="updateCache" reRender="hlPanel"/>
            <c:ACETCaseActions Save="{!Save}" SaveAndClose="{!SaveAndClose}" attrCaseDataWrapper="{!wrapper}" attrSourceOriginator="{!wrapper.SourceOriginator}" attrInteractionId="{!wrapper.Interaction.Id}" attrSubjectId="{!wrapper.Subject.Id}" attrShowMisdirectButton="true" attrRefreshNavigationTab="true"/>
        </apex:pageBlock>
        <script> 
            var subjectTabArray = new Array();
            function init() { 
	            //To Allow only digits for Group Tax ID 
			    
			    	$("[id$='groupTaxId']").keypress(function (InputElement) {
			    	
			            //Allow delete, tab, enter and escape keys through
			            if (/^(8|9|13|27)$/.test("" + InputElement.keyCode))
			            {
			                return true;
			            }
			    
			            var regex = new RegExp("^[0-9]+$");
			            var str = String.fromCharCode(!InputElement.charCode ? InputElement.which : InputElement.charCode);
			            if (regex.test(str))
			            {
			                return true;
			            }
			    
			            InputElement.preventDefault();
			            return false;
			            });
			    
        } 
        
        var pushSubjectToArray = function pushSubjectToArray(result) {
            if (result.success == true) {
                subjectTabArray.push(result.id);
                subjectTabArrayStr = JSON.stringify(subjectTabArray);
                localStorage.setItem('subjectTabArray', subjectTabArrayStr);
            }
        };
         
        function openSuccess(){}
        
        function testSetTabTitle() {
            //Set the current tabs title
            sforce.console.setTabTitle('Group Search');
        }
        var pageLoad = window.onload;
        window.onload = function() {
            if (pageLoad) {
                    pageLoad();
            }
            testSetTabTitle();
        }
        function validate(){
        
            var $pbSearch = $("[id$='pbSearch']");
            var $groupId = $("[id$='groupId']");
            var $groupTaxId = $("[id$='groupTaxId']");
            var $groupName = $("[id$='groupName']");
            var $statecode = $("[id$='searchstate']");
                        
            $pbSearch.find(".pbError").remove();  
            $groupId.removeClass("error").parent().find(".errorMsg").remove();
            $groupTaxId.removeClass("error").parent().find(".errorMsg").remove();
            $groupName.removeClass("error").parent().find(".errorMsg").remove();
            $statecode.removeClass("error").parent().find(".errorMsg").remove();
             
            var ValidationResult = true;
            console.log('Validation');
            
            
            if($groupId.val() && $groupTaxId.val()) {
            		console.log('Validation Entered both ID and Tax ID');
            		var errorMsg = 'Please search by either Group ID or Group Tax ID';    
                    $("[id$='pbSearch']").prepend('<div class="pbError">Error: Invalid Data. <br/>' + errorMsg + '</div>');
                    //$groupId.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong> ' + errorMsg + '</div>'); 
                    ValidationResult = false;
            }
            
            else if($groupId.val()) {
                if(($groupId.val().length < 7 || $groupId.val().length > 19)) 
                {   
                	console.log('Validation Invalid Group ID');              
                    var errorMsg = 'Enter Valid Group ID';    
                    $groupId.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong> ' + errorMsg + '</div>'); 
                    ValidationResult = false;
                }     
                     
            }
            else if($groupTaxId.val()) {
                if(($groupTaxId.val().length != 9)) 
                {
                	console.log('Validation Invalid Group Tax ID');  
                    var errorMsg = 'Enter Valid Group Tax ID';    
                    $groupTaxId.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong> ' + errorMsg + '</div>'); 
                    ValidationResult = false;
                }     
                     
            }
            
            else 
            {
                if(!$groupId.val() && !$groupTaxId.val() && !$groupName.val() && !$statecode.val()) 
                {
                        var errorMsg = 'Group ID or Group Tax ID or Group Name Search is Required';    
                        $("[id$='pbSearch']").prepend('<div class="pbError">Error: Invalid Data. <br/>' + errorMsg + '</div>');
                        ValidationResult = false;
                              
                }
                else if(!$statecode.val() && $groupName.val() && $groupName.val().indexOf('*') > -1 && $groupName.val().length < 4) 
                {   
                    var errmsg1 = 'Name search requires Group Name and State.';
                    var errorMsg = 'You must enter at least 3 characters with a wildcard search.';    
                    $statecode.addClass("error"); 
                    $groupName.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong> ' + errorMsg + '</div>');
                    $("[id$='pbSearch']").prepend('<div class="pbError">Error: Invalid Data. <br/>' + errmsg1 + '</div>'); 
                    ValidationResult = false;
                } 
                else if($groupName.val() && $groupName.val().indexOf('*') > -1 && $groupName.val().length < 4) 
                {   
                    var errmsg1 = 'Name search requires Group Name and State.';
                    var errorMsg = 'You must enter at least 3 characters with a wildcard search.';    
                   // $statecode.addClass("error"); 
                    $groupName.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong> ' + errorMsg + '</div>');
                    $("[id$='pbSearch']").prepend('<div class="pbError">Error: Invalid Data. <br/>' + errmsg1 + '</div>'); 
                    ValidationResult = false;
                }    
                else if(!$statecode.val() && $groupName.val().length > 1 && !$groupId.val() && !$groupTaxId.val()) 
                {   
                    var errorMsg = 'Name Search requires Group Name and State';    
                    $statecode.addClass("error"); 
                    $("[id$='pbSearch']").prepend('<div class="pbError">Error: Invalid Data. <br/>' + errorMsg + '</div>'); 
                    ValidationResult = false;
                }                   
                else if($groupName.val().length == 1 && !$groupId.val() && !$groupTaxId.val() )
                {
                    if(!$statecode.val())
                    {
                        var errorMsg1 = 'You must enter at least 2 characters';    
                        var errorMsg2 = 'Name Search requires Group Name and State';    
                        
                        $statecode.addClass("error"); 
                        $groupName.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong> ' + errorMsg1 + '</div>'); 
                        $("[id$='pbSearch']").prepend('<div class="pbError">Error: Invalid Data. <br/>' + errorMsg2 + '</div>'); 
                        ValidationResult = false;
                    }
                    else 
                    {
                        var errorMsg1 = 'You must enter at least 2 characters';    
                        
                        $groupName.addClass("error").parent().append('<div class="errorMsg"><strong>Error:</strong> ' + errorMsg1 + '</div>'); 
                        ValidationResult = false;
    
                    }      
                }
                else if(!$groupName.val() && !$groupId.val() && !$groupTaxId.val() && $statecode.val())
                {
                        var errorMsg = 'Name Search requires Group Name and State';    
                        $groupName.addClass("error")
                        $("[id$='pbSearch']").prepend('<div class="pbError">Error: Invalid Data. <br/>' + errorMsg + '</div>'); 
                        ValidationResult = false;
                         
                }
                
           }
    
        return ValidationResult;


        }
        
        function clearForm(){
            $("[id$='btnClear']").closest('form').find("input[type=text], select, input[type=hidden]").val(""); 
            
            return true;            
        }
        function setPriTabStyle(result) { 
            if (result.success) {
                sforce.console.setTabStyle('background: ;', result.id);
            } 
        }
        function onloadSetTabTitle() {
            //Set the current tabs title
            sforce.console.getEnclosingPrimaryTabId(setPriTabStyle);
            sforce.console.setTabTitle('Group Search');            
        }
        
              
        function processDatatable(row, data, dataIndex){
            $(row).children().first().html("<a id='groupLink' href='#'>" + data.groupName + "</a>");                      
            var sourceOriginator = $("[id$='sourceOriginator']").val();
            var interactionId = "{!Interaction.Id}";
                                                                    
            $(row).children().first().on('click', function(e){ 
                if(!interactionId){                             
                    Visualforce.remoting.Manager.invokeAction(
                       '{!$RemoteAction.ACETSearchEmployerGroupController.createInteraction}',
                       sourceOriginator,
                       interactionId,                   
                       function(result, event){
                          navigateToDetail(result,data);                                 
                       }, 
                       {escape: true}
                   );
               }else{
                    navigateToDetail(interactionId,data); 
               }
               return false;
            }); 
                     
        }
       
        function navigateToDetail(interactionId, memberResult){                           
              var OriginatorType = '{!JSENCODE(Interaction.Originator_Type__c)}';              
              var vccdParams =  '{!$CurrentPage.parameters.vccdParams}';//Added by Swetha              
              var tabName = 'Detail - '+ memberResult.groupName;
              var hightlightPanelInfo = $("[id$='highlightPanelInfo']").val(); 
              var subject = memberResult.subjectid;
              var url = '/apex/ACETViewEmployerGroup?groupName=' + memberResult.groupName + '&taxId=' + memberResult.taxid + '&Id=' + memberResult.groupId + '&sourceOriginator=' + $("[id$='sourceOriginator']").val() + '&InteractionId=' + interactionId +'&additionalInfo='+hightlightPanelInfo;                                        
              var tabIdUsngClntId= memberResult.groupId;
               if(vccdParams != null || vccdParams != undefined){
                   url = url + '&vccdParams=' + vccdParams;
               }
               if(OriginatorType == 'Producer') {
                   sforce.console.getFocusedPrimaryTabId(function(result) {
                       sforce.console.openSubtab(result.id, url, true, tabName,null,pushSubjectToArray);
                   });
               }
               else{
                    sforce.console.openPrimaryTab('', url, true, tabName, openSuccess, tabIdUsngClntId);                   
               }
               return false;                                             
        } 
        
        $(document).ready(function() {  
            onloadSetTabTitle();
            init();  
            var noAutoSearch = '{!JSENCODE($CurrentPage.parameters.noAutoSearch)}';
            if(noAutoSearch != 'true'){
               var vccdParams =  JSON.parse('{!JSENCODE($CurrentPage.parameters.vccdParams)}');
               $("[id$='groupId']").val(vccdParams.groupId);
               if(vccdParams.groupId != '')
                   $("[id$='groupId']").val(vccdParams.groupId);               
               $("[id$='btnSearch']").click();

            }
            if('{!Results.size}' == 1 && noAutoSearch == 'true'){
               $("[id$='groupLink']").click();
            }
        });
        
        </script> 
        </apex:outputPanel>
                   
            
     </apex:form> 
     
     <apex:includeScript value="{!URLFOR($Resource.ACETResources, '/js/main.js')}"/> 
    
</apex:page>